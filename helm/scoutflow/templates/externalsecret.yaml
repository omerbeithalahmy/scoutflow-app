# ============================================================================
# ExternalSecret Specification
# Maps AWS Secrets Manager credentials to Kubernetes Secret resources
# ============================================================================

{{- if .Values.externalSecrets.enabled }}
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ .Release.Name }}-db-external-secret
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: {{ .Release.Name }}
    app.kubernetes.io/component: externalsecret
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: {{ .Release.Name }}-secretstore
    kind: ClusterSecretStore
  target:
    name: {{ .Release.Name }}-db-secret
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        DB_USER: "{{ `{{ .username }}` }}"
        DB_PASSWORD: "{{ `{{ .password }}` }}"
        DB_NAME: "{{ `{{ .database }}` }}"
  data:
  - secretKey: username
    remoteRef:
      key: {{ .Values.externalSecrets.secretName }}
      property: username
  - secretKey: password
    remoteRef:
      key: {{ .Values.externalSecrets.secretName }}
      property: password
  - secretKey: database
    remoteRef:
      key: {{ .Values.externalSecrets.secretName }}
      property: database
{{- end }}
